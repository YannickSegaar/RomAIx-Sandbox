<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voiceflow Chat API Trigger</title>
  <style>
    body {
      background-color: #f9f9f9;
    }
    #flat-chat {
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
    }
    #confetti-canvas {
      position: fixed;
      z-index: 999;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
    }
    .container {
      max-width: 800px;
      text-align: center;
    }
    h1 {
      color: #333;
    }
    .status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 5px;
      background-color: #f5f5f5;
      display: inline-block;
    }
    .status.ready {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    .status.error {
      background-color: #ffebee;
      color: #c62828;
    }
    .btn {
      background-color: #587C74;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
      font-size: 16px;
    }
    .btn:hover {
      background-color: #2F3E46;
    }
  </style>
</head>
<body>
  <!-- Confetti Canvas -->
  <canvas id="confetti-canvas"></canvas>

  <!-- Container for Content -->
  <div class="container">
    <h1>RomAIx Voiceflow Integration</h1>
    <p>This page includes a Voiceflow chat agent that can be triggered via API call.</p>
    <div id="status" class="status">Loading Voiceflow chat widget...</div>
    
    <!-- Test button (for manual testing) -->
    <button id="test-btn" class="btn">Test Open Chat</button>
  </div>

  <!-- Voiceflow Chat Widget Container -->
  <div id="voiceflow-chat-frame"></div>

  <!-- Script for Chat Trigger API -->
  <script>
    // This variable will be used to track the last processed trigger and store execution data
    let lastProcessedTrigger = 0;
    let n8n_executionID = null;
    let n8n_resumeURL = null;
    const statusElement = document.getElementById('status');
    const testBtn = document.getElementById('test-btn');
    
    // Window object to store data for extensions
    window.romaixData = { 
      n8n_executionID: null, 
      n8n_resumeURL: null 
    };

    // Function to initialize Voiceflow chat with current data
    function initializeVoiceflowChat() {
      console.log("Initializing Voiceflow chat with data:", window.romaixData);
      
      return window.voiceflow.chat.load({
        verify: { projectID: '6798b43c9f655dc50cb7cb58' },
        url: 'https://general-runtime.voiceflow.com',
        versionID: 'production',
        voice: { 
          url: "https://runtime-api.voiceflow.com" 
        },
        user: {
          name: 'Demo User',
        },
        render: {
          mode: 'overlay',
        },
        autostart: false,
        allowDangerousHTML: true,
        launch: {
          event: {
            type: 'launch',
            payload: {
              n8n_executionID: window.romaixData.n8n_executionID,
              n8n_resumeURL: window.romaixData.n8n_resumeURL
            }
          }
        },
        assistant: {
          extensions: [
            VideoExtension,
            TimerExtension,
            FormExtension,
            MapExtension,
            FileUploadExtension,
            KBUploadExtension,
            DateExtension,
            ConfettiExtension,
            GTH_FormExtension,
            GTH_FeedbackExtension,
            WaitingAnimationExtension,
            GiftCardDisplayExtension,
            DoneAnimationExtension,
            InvisibleTimerExtension,
            DisableInputExtension,
            makeToVoiceflowExtension,
            RescheduleCancelFormExtension,
            IframeEmbedExtension,
            CustomizedIframeExtension,
            DirectionsWorkflowExtension,
            DirectionsWorkflowExtension2,
            DirectionsWorkflowExtension3,
            DirectionsWorkflowExtension4,
            DirectionsWorkflowExtension5,
            DirectionsWorkflowExtension6,
            DirectionsWorkflowExtension7,
            DirectionsWorkflowExtension8,
            DirectionsWorkflowExtension9,
            DirectionsWorkflowExtension10,
            DirectionsWorkflowExtension11,
            DirectionsWorkflowExtension12,
            DirectionsWorkflowExtension13,
            DirectionsWorkflowExtension14,
            DirectionsWorkflowExtension15,
            DirectionsWorkflowExtension16,
            DirectionsWorkflowExtension17,
            DirectionsWorkflowExtension18,
            DirectionsWorkflowExtension19,
            DirectionsWorkflowExtension20,
            DirectionsWorkflowExtension22,
            GTH_FormExtension2,
            RomAIxWebhookExtension1,
            RomAIxWebhookExtension2
          ],
          stylesheet: "https://yannicksegaar.github.io/VF-extensions/chat-widget-custom_FareHarborCarousel.css",
        },
      }).then(() => {
        console.log("Voiceflow chat initialized successfully with payload:", {
          n8n_executionID: window.romaixData.n8n_executionID,
          n8n_resumeURL: window.romaixData.n8n_resumeURL
        });
        statusElement.textContent = 'Voiceflow chat initialized successfully. Ready for triggers.';
        statusElement.className = 'status ready';
      }).catch((error) => {
        console.error("Error initializing Voiceflow chat:", error);
        statusElement.textContent = 'Error initializing Voiceflow chat: ' + error.message;
        statusElement.className = 'status error';
      });
    }
  
    // Function to check if the chat should be opened
    function checkChatTrigger() {
      fetch('/api/check-chat-trigger?' + new Date().getTime())
        .then(response => {
          if (!response.ok) {
            throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.triggerId && data.triggerId > lastProcessedTrigger) {
            lastProcessedTrigger = data.triggerId;
            
            // Update the global variables and window object
            n8n_executionID = data.n8n_executionID;
            n8n_resumeURL = data.n8n_resumeURL;
            
            window.romaixData = {
              n8n_executionID: n8n_executionID,
              n8n_resumeURL: n8n_resumeURL
            };
            
            statusElement.textContent = `Received trigger ID: ${data.triggerId}, opening chat with n8n_executionID: ${n8n_executionID}`;
            statusElement.className = 'status ready';
  
            console.log('Opening chat due to API trigger with data:', window.romaixData);
            
            // Make sure Voiceflow is loaded before trying to open
            if (window.voiceflow && window.voiceflow.chat) {
              // Destroy any existing chat instance (if possible)
              if (window.voiceflow.chat.destroy) {
                window.voiceflow.chat.destroy().then(() => {
                  // Reinitialize with new data
                  initializeVoiceflowChat().then(() => {
                    window.voiceflow.chat.open();
                  });
                });
              } else {
                // If no destroy method, try to reinitialize
                initializeVoiceflowChat().then(() => {
                  window.voiceflow.chat.open();
                });
              }
            } else {
              console.warn('Voiceflow chat not yet loaded');
              statusElement.textContent = 'Voiceflow chat not yet loaded. Waiting for initialization...';
            }
          }
        })
        .catch(error => {
          console.error('Error checking chat trigger:', error);
          statusElement.textContent = 'Error checking API: ' + error.message;
          statusElement.className = 'status error';
        });
    }
  
    // Test button to manually open chat
    testBtn.addEventListener('click', () => {
      if (window.voiceflow && window.voiceflow.chat) {
        window.voiceflow.chat.open();
        statusElement.textContent = 'Chat opened manually';
        statusElement.className = 'status ready';
      } else {
        statusElement.textContent = 'Voiceflow chat not loaded yet';
        statusElement.className = 'status error';
      }
    });
  
    // Start checking for triggers once the page is loaded
    document.addEventListener('DOMContentLoaded', () => {
      statusElement.textContent = 'Page loaded, connecting to API...';
      // Check every 3 seconds
      setInterval(checkChatTrigger, 3000);
    });
  </script>

  <!-- Canvas Confetti Script -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <!-- Voiceflow Chat Widget and Extensions Script -->
  <script type="module">
    console.log("Script loaded. Initializing Voiceflow chat widget...");

    // Import extensions from the extensions.js file
    import {
      VideoExtension,
      TimerExtension,
      FormExtension,
      MapExtension,
      FileUploadExtension,
      KBUploadExtension,
      DateExtension,
      ConfettiExtension,
      GTH_FormExtension,
      GTH_FeedbackExtension,
      WaitingAnimationExtension,
      GiftCardDisplayExtension,
      DoneAnimationExtension,
      InvisibleTimerExtension,
      DisableInputExtension,
      makeToVoiceflowExtension,
      RescheduleCancelFormExtension,
      IframeEmbedExtension,
      CustomizedIframeExtension,
      DirectionsWorkflowExtension,
      DirectionsWorkflowExtension2,
      DirectionsWorkflowExtension3,
      DirectionsWorkflowExtension4,
      DirectionsWorkflowExtension5,
      DirectionsWorkflowExtension6,
      DirectionsWorkflowExtension7,
      DirectionsWorkflowExtension8,
      DirectionsWorkflowExtension9,
      DirectionsWorkflowExtension10,
      DirectionsWorkflowExtension11,
      DirectionsWorkflowExtension12,
      DirectionsWorkflowExtension13,
      DirectionsWorkflowExtension14,
      DirectionsWorkflowExtension15,
      DirectionsWorkflowExtension16,
      DirectionsWorkflowExtension17,
      DirectionsWorkflowExtension18,
      DirectionsWorkflowExtension19,
      DirectionsWorkflowExtension20,
      DirectionsWorkflowExtension22,
      GTH_FormExtension2,
      RomAIxWebhookExtension1,
      RomAIxWebhookExtension2
    } from '/extensions_New.js';

    // Load the Voiceflow chat widget with extensions
    (function (d, t) {
      var v = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
      v.onload = function () {
        console.log("Voiceflow widget script loaded. Initializing chat...");
        // Initial load with empty values
        initializeVoiceflowChat();
      };
      v.src = 'https://cdn.voiceflow.com/widget-next/bundle.mjs'; // Updated to the new widget version
      v.type = 'text/javascript';
      s.parentNode.insertBefore(v, s);
    })(document, 'script');
  </script>
</body>
</html>