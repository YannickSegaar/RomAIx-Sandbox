<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voiceflow Chat API Trigger</title>
  <style>
    /* ... (keep existing CSS) ... */
     body {
      background-color: #f9f9f9;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    #flat-chat {
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
    }
    #confetti-canvas {
      position: fixed;
      z-index: 999;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 5px;
      background-color: #f5f5f5;
      display: inline-block;
    }
    .status.ready {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    .status.error {
      background-color: #ffebee;
      color: #c62828;
    }
    .btn {
      background-color: #587C74;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
      font-size: 16px;
    }
    .btn:hover {
      background-color: #2F3E46;
    }
  </style>
</head>
<body>
  <canvas id="confetti-canvas"></canvas>

  <div class="container">
    <h1>RomAIx Voiceflow Integration</h1>
    <p>This page includes a Voiceflow chat agent that can be triggered via API call.</p>
    <div id="status" class="status">Loading Voiceflow chat widget...</div>

    <button id="test-btn" class="btn">Test Open Chat Manually</button>
  </div>

  <div id="voiceflow-chat-frame"></div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <script>
    // Global variables
    let lastProcessedTrigger = 0;
    const statusElement = document.getElementById('status');
    const testBtn = document.getElementById('test-btn');

    // Store N8N data globally if needed as a fallback (though primary method is interact payload)
    window.romaixData = {
      n8n_executionID: null,
      n8n_resumeURL: null
    };

    // Function to check if the chat should be opened
    function checkChatTrigger() {
      fetch('/api/check-chat-trigger?' + new Date().getTime()) // Cache buster
        .then(response => {
          if (!response.ok) {
            throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.triggerId && data.triggerId > lastProcessedTrigger) {
            console.log(`New trigger detected: ID ${data.triggerId}, Previous: ${lastProcessedTrigger}`);
            lastProcessedTrigger = data.triggerId;

            // Store data globally (optional fallback)
            window.romaixData.n8n_executionID = data.n8n_executionID;
            window.romaixData.n8n_resumeURL = data.n8n_resumeURL;

            statusElement.textContent = `Received trigger ID: ${data.triggerId}. Launching chat with N8N data...`;
            statusElement.className = 'status ready';

            console.log('Received N8N data:', window.romaixData);

            // Make sure Voiceflow is loaded before trying to interact
            if (window.voiceflow && window.voiceflow.chat) {
              console.log('Calling voiceflow.chat.interact with launch payload:', {
                n8n_executionID: data.n8n_executionID,
                n8n_resumeURL: data.n8n_resumeURL
              });
              // Use interact with type 'launch' and pass the N8N data in the payload
              window.voiceflow.chat.interact({
                type: 'launch',
                payload: {
                  n8n_executionID: data.n8n_executionID,
                  n8n_resumeURL: data.n8n_resumeURL
                }
              });
              statusElement.textContent = `Voiceflow chat launched via API trigger ${data.triggerId}.`;
            } else {
              console.warn('Voiceflow chat not yet loaded when trigger arrived. Interaction might fail.');
              statusElement.textContent = 'Voiceflow chat not yet loaded. Waiting for initialization...';
              // Consider adding logic here to retry the interact call once VF is loaded
            }
          } else {
             // console.log(`No new trigger. Current: ${data.triggerId}, Last processed: ${lastProcessedTrigger}`);
          }
        })
        .catch(error => {
          console.error('Error checking chat trigger:', error);
          statusElement.textContent = 'Error checking API: ' + error.message;
          statusElement.className = 'status error';
        });
    }

    // Test button to manually open chat (without N8N data)
    testBtn.addEventListener('click', () => {
      if (window.voiceflow && window.voiceflow.chat) {
        window.voiceflow.chat.open(); // Just open, no specific launch payload
        statusElement.textContent = 'Chat opened manually';
        statusElement.className = 'status ready';
      } else {
        statusElement.textContent = 'Voiceflow chat not loaded yet';
        statusElement.className = 'status error';
      }
    });

    // Start checking for triggers once the page is loaded
    document.addEventListener('DOMContentLoaded', () => {
      statusElement.textContent = 'Page loaded, initializing Voiceflow and connecting to API...';
      // Check every 3 seconds
      setInterval(checkChatTrigger, 3000);
      console.log("Polling for N8N triggers started.");
    });
  </script>

  <script>
    window.VideoExtension = { name: 'Video', type: 'response', match: () => false, render: () => {} };
    // ... keep all other placeholder extensions ...
    window.RomAIxWebhookExtension2 = { name: 'RomAIxWebhookForm', type: 'response', match: () => false, render: () => {} };
  </script>

  <script>
    // Fetch the extension implementation (Keep as is)
    fetch('/extensions_New.js') // Ensure this filename matches your actual file
      .then(response => response.text())
      .then(code => {
         // Execute the code to define the actual extension
         try {
           // Use Function constructor for cleaner execution scope if needed
           const defineExtension = new Function(code + '\n window.RomAIxWebhookExtension2 = RomAIxWebhookExtension2;');
           defineExtension();
           console.log('Successfully loaded and defined RomAIxWebhookExtension2 from extensions_New.js');

           // Re-register the loaded extension if Voiceflow is already initialized
           if (window.voiceflow?.assistant) {
                console.log('Attempting to re-register extension post-load.');
                // Note: Voiceflow's API for adding extensions after load might be limited.
                // Usually, extensions need to be defined *before* chat.load()
                // This might require ensuring the JS file loads *before* the VF load script runs.
                // Consider moving the extension loading <script> *before* the VF load <script>.
           }

         } catch (e) {
             console.error('Error executing code from extensions_New.js:', e);
         }
      })
      .catch(error => {
        console.error('Error loading extensions_New.js:', error);
      });
  </script>

  <script>
    // Load the Voiceflow chat widget
    (function (d, t) {
      var v = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
      v.onload = function () {
        console.log("Voiceflow widget script loaded. Initializing chat...");

        window.voiceflow.chat.load({
          verify: { projectID: '6798b43c9f655dc50cb7cb58' }, // Replace with your Project ID
          url: 'https://general-runtime.voiceflow.com',
          versionID: 'production', // Or 'development'
          // --- REMOVED launch property from here ---
          user: {
            name: 'Demo User', // Optional: Set user name
          },
          render: {
            mode: 'overlay', // Or 'embedded'
            // container: document.getElementById('voiceflow-chat-frame'), // Needed for embedded mode
          },
          autostart: false, // Important: Do not start automatically, wait for N8N trigger
          allowDangerousHTML: true, // Be careful with this in production
          assistant: {
             // Ensure extensions are defined *before* this runs.
            extensions: [
              // It's crucial that window.RomAIxWebhookExtension2 is the *actual* loaded extension object here
              window.VideoExtension, window.TimerExtension, window.FormExtension, window.MapExtension,
              window.FileUploadExtension, window.KBUploadExtension, window.DateExtension, window.ConfettiExtension,
              window.GTH_FormExtension, window.GTH_FeedbackExtension, window.WaitingAnimationExtension,
              window.GiftCardDisplayExtension, window.DoneAnimationExtension, window.InvisibleTimerExtension,
              window.DisableInputExtension, window.makeToVoiceflowExtension, window.RescheduleCancelFormExtension,
              window.IframeEmbedExtension, window.CustomizedIframeExtension, window.DirectionsWorkflowExtension,
              window.DirectionsWorkflowExtension2, window.DirectionsWorkflowExtension3, window.DirectionsWorkflowExtension4,
              window.DirectionsWorkflowExtension5, window.DirectionsWorkflowExtension6, window.DirectionsWorkflowExtension7,
              window.DirectionsWorkflowExtension8, window.DirectionsWorkflowExtension9, window.DirectionsWorkflowExtension10,
              window.DirectionsWorkflowExtension11, window.DirectionsWorkflowExtension12, window.DirectionsWorkflowExtension13,
              window.DirectionsWorkflowExtension14, window.DirectionsWorkflowExtension15, window.DirectionsWorkflowExtension16,
              window.DirectionsWorkflowExtension17, window.DirectionsWorkflowExtension18, window.DirectionsWorkflowExtension19,
              window.DirectionsWorkflowExtension20, window.DirectionsWorkflowExtension22, window.GTH_FormExtension2,
              window.RomAIxWebhookExtension1, window.RomAIxWebhookExtension2, window.RomAIxWebhookExtension3 // Ensure this is the *real* one
            ],
            stylesheet: "https://yannicksegaar.github.io/VF-extensions/chat-widget-custom_FareHarborCarousel.css", // Optional styling
          },
        }).then(() => {
          console.log("Voiceflow chat framework initialized successfully.");
          if (statusElement.textContent.includes('Loading') || statusElement.textContent.includes('Waiting')) {
              statusElement.textContent = 'Voiceflow chat initialized. Ready for triggers.';
              statusElement.className = 'status ready';
          }
        }).catch((error) => {
          console.error("Error initializing Voiceflow chat:", error);
          statusElement.textContent = 'Error initializing Voiceflow chat: ' + error.message;
          statusElement.className = 'status error';
        });
      };
      v.src = 'https://cdn.voiceflow.com/widget-next/bundle.mjs';
      v.type = 'text/javascript';
      s.parentNode.insertBefore(v, s); // Insert Voiceflow script
    })(document, 'script');
  </script>
</body>
</html>