<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payload Pass Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f8f9fa;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .status-box {
      margin: 20px 0;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 4px;
    }
    .log-box {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f8f8f8;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Payload Pass Test</h1>
    
    <div class="status-box">
      <strong>Status:</strong> <span id="status">Waiting for API call</span>
    </div>
    
    <div id="log-box" class="log-box"></div>
  </div>

  <script>
    // Function to log messages
    function log(message) {
      const logBox = document.getElementById('log-box');
      const timestamp = new Date().toLocaleTimeString();
      logBox.innerHTML += `<div>[${timestamp}] ${message}</div>`;
      logBox.scrollTop = logBox.scrollHeight;
      console.log(`[${timestamp}] ${message}`);
    }
    
    // Function to update status
    function updateStatus(message) {
      document.getElementById('status').textContent = message;
      log(message);
    }
    
    // Global variables
    let lastTriggerId = 0;
    
    // Function to check for API triggers
    function checkApiTrigger() {
      fetch(`/api/check-chat-trigger?t=${Date.now()}`)
        .then(response => response.json())
        .then(data => {
          // If new trigger detected
          if (data.triggerId && data.triggerId > lastTriggerId) {
            lastTriggerId = data.triggerId;
            
            log(`New trigger detected! ID: ${data.triggerId}`);
            log(`Payload: n8n_executionID=${data.n8n_executionID}, n8n_resumeURL=${data.n8n_resumeURL}`);
            
            // Store data on window object for Voiceflow
            window.triggerData = {
              n8n_executionID: data.n8n_executionID,
              n8n_resumeURL: data.n8n_resumeURL
            };
            
            updateStatus('Processing trigger...');
            
            // IMPORTANT: Use this specific sequence to ensure the payload is passed
            
            // 1. First, prepare the payload
            const payload = {
              n8n_executionID: data.n8n_executionID,
              n8n_resumeURL: data.n8n_resumeURL
            };
            
            log('Step 1: Prepared payload');
            
            if (window.voiceflow && window.voiceflow.chat) {
              // 2. Reset conversation (optional but helps ensure clean state)
              window.voiceflow.chat.destroy()
                .then(() => {
                  log('Step 2: Destroyed previous chat instance');
                  
                  // 3. Initialize with launch payload 
                  return window.voiceflow.chat.load({
                    verify: { projectID: '6798b43c9f655dc50cb7cb58' },
                    url: 'https://general-runtime.voiceflow.com',
                    versionID: 'production',
                    autostart: false,
                    launch: {
                      event: {
                        type: 'launch',
                        payload: payload
                      }
                    }
                  });
                })
                .then(() => {
                  log('Step 3: Initialized with launch payload');
                  
                  // 4. Wait briefly to ensure payload is processed
                  return new Promise(resolve => setTimeout(resolve, 500));
                })
                .then(() => {
                  // 5. Send direct interact with payload again (belt and suspenders approach)
                  return window.voiceflow.chat.interact({
                    type: 'launch',
                    payload: payload
                  });
                })
                .then(() => {
                  log('Step 4: Sent interact with payload');
                  
                  // 6. Finally open the chat
                  window.voiceflow.chat.open();
                  log('Step 5: Opened chat with payload');
                  updateStatus('Chat opened with payload!');
                })
                .catch(error => {
                  log(`Error: ${error.message}`);
                  updateStatus('Error occurred');
                });
            } else {
              log('Voiceflow not ready yet, trying to initialize...');
              loadVoiceflow(payload);
            }
          }
        })
        .catch(error => {
          log(`API check error: ${error.message}`);
        });
    }
    
    // Function to load Voiceflow with payload
    function loadVoiceflow(payload) {
      log('Loading Voiceflow...');
      
      const script = document.createElement('script');
      script.src = 'https://cdn.voiceflow.com/widget-next/bundle.mjs';
      script.type = 'text/javascript';
      
      script.onload = function() {
        log('Voiceflow script loaded');
        
        // Initialize with launch payload
        window.voiceflow.chat.load({
          verify: { projectID: '6798b43c9f655dc50cb7cb58' },
          url: 'https://general-runtime.voiceflow.com',
          versionID: 'production',
          autostart: false,
          launch: {
            event: {
              type: 'launch',
              payload: payload
            }
          }
        }).then(() => {
          log('Voiceflow initialized with launch payload');
          
          // Send interact with payload
          return window.voiceflow.chat.interact({
            type: 'launch',
            payload: payload
          });
        }).then(() => {
          log('Sent interact with payload');
          
          // Open the chat
          window.voiceflow.chat.open();
          log('Opened chat with payload');
          updateStatus('Chat opened with payload!');
        }).catch(error => {
          log(`Voiceflow error: ${error.message}`);
          updateStatus('Error occurred');
        });
      };
      
      document.body.appendChild(script);
    }
    
    // Initialize
    function init() {
      log('Page loaded, waiting for API triggers...');
      // Initial load of Voiceflow (without opening)
      const script = document.createElement('script');
      script.src = 'https://cdn.voiceflow.com/widget-next/bundle.mjs';
      script.type = 'text/javascript';
      document.body.appendChild(script);
      
      // Start polling for API triggers
      setInterval(checkApiTrigger, 3000);
    }
    
    // Start when page loads
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>