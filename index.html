<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API-Triggered Voiceflow Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f9f9f9;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      max-width: 800px;
      text-align: center;
    }
    .status {
      margin: 20px 0;
      padding: 10px 20px;
      border-radius: 4px;
      display: inline-block;
      font-size: 16px;
    }
    .idle {
      background-color: #f0f0f0;
      color: #666;
    }
    .ready {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    .error {
      background-color: #ffebee;
      color: #c62828;
    }
    .data-display {
      background-color: #f0f0f0;
      border-radius: 5px;
      padding: 10px;
      margin-top: 20px;
      text-align: left;
      width: 100%;
      max-width: 600px;
    }
    .data-row {
      display: flex;
      margin-bottom: 8px;
    }
    .data-label {
      font-weight: bold;
      width: 120px;
    }
    .data-value {
      flex: 1;
      word-break: break-all;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>API-Triggered Voiceflow Chat</h1>
    <p>Send a POST request to <strong>/api/trigger-chat</strong> with executionID and resumeURL to open the chat</p>
    
    <div id="status" class="status idle">Waiting for API trigger...</div>
    
    <div class="data-display">
      <h3>Last Trigger Data:</h3>
      <div class="data-row">
        <div class="data-label">Trigger ID:</div>
        <div id="triggerId" class="data-value">None</div>
      </div>
      <div class="data-row">
        <div class="data-label">Execution ID:</div>
        <div id="executionId" class="data-value">None</div>
      </div>
      <div class="data-row">
        <div class="data-label">Resume URL:</div>
        <div id="resumeUrl" class="data-value">None</div>
      </div>
      <div class="data-row">
        <div class="data-label">Status:</div>
        <div id="apiStatus" class="data-value">No API calls received</div>
      </div>
    </div>
  </div>

  <script>
    // DOM elements
    const statusElement = document.getElementById('status');
    const triggerIdElement = document.getElementById('triggerId');
    const executionIdElement = document.getElementById('executionId');
    const resumeUrlElement = document.getElementById('resumeUrl');
    const apiStatusElement = document.getElementById('apiStatus');
    
    // Variables to track state
    let lastProcessedTrigger = 0;
    let isVoiceflowLoaded = false;
    
    // Store API data in window object
    window.apiData = {
      n8n_executionID: null,
      n8n_resumeURL: null
    };
    
    // Load Voiceflow widget but don't open it yet
    function loadVoiceflowWidget() {
      const script = document.createElement('script');
      script.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs";
      script.type = "text/javascript";
      script.onload = function() {
        console.log("Voiceflow widget script loaded");
        
        window.voiceflow.chat.load({
          verify: { projectID: '6798b43c9f655dc50cb7cb58' },
          url: 'https://general-runtime.voiceflow.com',
          versionID: 'production',
          voice: { url: "https://runtime-api.voiceflow.com" },
          user: { name: 'API User' },
          render: { mode: 'overlay' },
          autostart: false, // Very important - don't open automatically
          allowDangerousHTML: true
        }).then(() => {
          console.log("Voiceflow chat initialized and ready");
          isVoiceflowLoaded = true;
          checkForTrigger(); // Check immediately in case we missed a trigger
        }).catch(error => {
          console.error("Error initializing Voiceflow chat:", error);
          statusElement.textContent = "Error loading Voiceflow chat: " + error.message;
          statusElement.className = "status error";
        });
      };
      
      document.body.appendChild(script);
    }
    
    // Function to check for API triggers
    function checkForTrigger() {
      fetch('/api/check-chat-trigger?' + new Date().getTime())
        .then(response => response.json())
        .then(data => {
          // Update display with latest data regardless of processing status
          triggerIdElement.textContent = data.triggerId || 'None';
          executionIdElement.textContent = data.n8n_executionID || 'None';
          resumeUrlElement.textContent = data.n8n_resumeURL || 'None';
          
          // If this is a new trigger (higher ID than last processed)
          if (data.triggerId && data.triggerId > lastProcessedTrigger) {
            console.log("New API trigger detected:", data);
            apiStatusElement.textContent = `New trigger received at ${new Date().toLocaleTimeString()}`;
            
            // Update last processed ID
            lastProcessedTrigger = data.triggerId;
            
            // Store data in the window object
            window.apiData.n8n_executionID = data.n8n_executionID;
            window.apiData.n8n_resumeURL = data.n8n_resumeURL;
            
            // Update display
            statusElement.textContent = "API trigger received! Opening chat...";
            statusElement.className = "status ready";
            
            // Open chat with the payload if Voiceflow is loaded
            if (isVoiceflowLoaded && window.voiceflow && window.voiceflow.chat) {
              // Send the payload and open chat
              window.voiceflow.chat.interact({
                type: 'launch',
                payload: {
                  n8n_executionID: data.n8n_executionID,
                  n8n_resumeURL: data.n8n_resumeURL
                }
              }).then(() => {
                console.log("Interact payload sent, opening chat");
                window.voiceflow.chat.open();
              }).catch(error => {
                console.error("Error sending payload:", error);
              });
            } else {
              console.warn("Voiceflow not ready yet, will retry...");
            }
          }
        })
        .catch(error => {
          console.error("Error checking for triggers:", error);
          apiStatusElement.textContent = "Error: " + error.message;
        });
    }
    
    // Start the application
    document.addEventListener('DOMContentLoaded', () => {
      // Load Voiceflow widget (but don't open it)
      loadVoiceflowWidget();
      
      // Start polling for triggers
      setInterval(checkForTrigger, 2000);
      
      console.log("App initialized, waiting for API triggers");
    });
  </script>
</body>
</html>